{{template "header" .}}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat"></i> Chat</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="clear-history" title="Clear chat history">
                        <i class="bi bi-trash"></i>
                    </button>
                    <span id="connection-status" class="badge bg-secondary">Connecting...</span>
                </div>
            </div>
            <div class="card-body chat-container" id="chat-messages">
                <!-- Messages will be inserted here -->
            </div>
            <div class="card-footer">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="btn btn-primary" id="send-btn">
                        <i class="bi bi-send"></i> Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    var eventSource = null;
    var reconnectTimer = null;
    var currentRunId = null;
    var $currentBubble = null;
    var $messages = $('#chat-messages');
    var $input = $('#message-input');
    var $sendBtn = $('#send-btn');
    var $status = $('#connection-status');
    var STORAGE_KEY = 'goclaw_chat_history';
    var MAX_MESSAGES = 100; // Keep last 100 messages

    // Load chat history from localStorage
    function loadHistory() {
        try {
            var history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history.forEach(function(msg) {
                renderMessage(msg.role, msg.content, false);
            });
            $messages.scrollTop($messages[0].scrollHeight);
        } catch (e) {
            console.error('Failed to load chat history:', e);
        }
    }

    // Save chat history to localStorage
    function saveHistory() {
        try {
            var messages = [];
            $messages.find('.message').each(function() {
                var $msg = $(this);
                var role = 'assistant';
                if ($msg.hasClass('user')) role = 'user';
                else if ($msg.hasClass('error')) role = 'error';
                else if ($msg.hasClass('mirror-user')) role = 'mirror-user';
                else if ($msg.hasClass('mirror-assistant')) role = 'mirror-assistant';
                messages.push({
                    role: role,
                    content: $msg.find('.bubble').text()
                });
            });
            // Keep only last MAX_MESSAGES
            if (messages.length > MAX_MESSAGES) {
                messages = messages.slice(-MAX_MESSAGES);
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        } catch (e) {
            console.error('Failed to save chat history:', e);
        }
    }

    // Clear chat history
    function clearHistory() {
        localStorage.removeItem(STORAGE_KEY);
        $messages.empty();
    }

    // Render a message (without saving - used for loading history)
    function renderMessage(role, content, save) {
        var roleClass = 'assistant';
        if (role === 'user') roleClass = 'user';
        else if (role === 'error') roleClass = 'error';
        else if (role.startsWith('mirror-')) roleClass = 'mirror ' + role;
        
        var $msg = $('<div class="message ' + roleClass + '">' +
            '<div class="bubble"></div>' +
            '</div>');
        $msg.find('.bubble').text(content);
        $messages.append($msg);
        
        if (save !== false) {
            saveHistory();
        }
        return $msg;
    }

    // Connect to SSE
    function connect() {
        // Close existing connection if any
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }
        
        $status.text('Connecting...').removeClass('bg-success bg-danger').addClass('bg-secondary');
        
        eventSource = new EventSource('/api/events');
        
        eventSource.addEventListener('connected', function(e) {
            $status.text('Connected').removeClass('bg-secondary bg-danger').addClass('bg-success');
        });
        
        eventSource.addEventListener('start', function(e) {
            var data = JSON.parse(e.data);
            currentRunId = data.RunID;
            // Create new bubble for this response
            var $msg = $('<div class="message assistant"><div class="bubble"></div></div>');
            $currentBubble = $msg.find('.bubble');
            $messages.append($msg);
            showTypingIndicator();
        });
        
        eventSource.addEventListener('message', function(e) {
            var data = JSON.parse(e.data);
            hideTypingIndicator();
            // Append delta to current bubble
            if ($currentBubble) {
                $currentBubble.text($currentBubble.text() + data.content);
                $messages.scrollTop($messages[0].scrollHeight);
            }
        });
        
        eventSource.addEventListener('done', function(e) {
            hideTypingIndicator();
            currentRunId = null;
            $currentBubble = null;
            saveHistory(); // Save after response complete
        });
        
        eventSource.addEventListener('mirror', function(e) {
            var data = JSON.parse(e.data);
            // Show mirrored conversation
            appendMessage('mirror-user', '[' + data.source + '] ' + data.userMsg);
            appendMessage('mirror-assistant', data.response);
        });
        
        eventSource.addEventListener('agent_error', function(e) {
            hideTypingIndicator();
            var data = JSON.parse(e.data);
            appendMessage('error', 'Error: ' + data.error);
            currentRunId = null;
            $currentBubble = null;
        });
        
        eventSource.addEventListener('agent_message', function(e) {
            var data = JSON.parse(e.data);
            if (data.type === 'text') {
                appendMessage('assistant', data.text);
            } else if (data.type === 'media') {
                // Show media with optional caption
                var $msg = $('<div class="message assistant"><div class="bubble media-bubble"></div></div>');
                var $bubble = $msg.find('.bubble');
                var $img = $('<img>').attr('src', data.url).attr('alt', data.filename || 'Media');
                $img.on('load', function() {
                    $messages.scrollTop($messages[0].scrollHeight);
                });
                $img.on('error', function() {
                    $img.replaceWith($('<span class="text-muted">Failed to load image</span>'));
                });
                $bubble.append($img);
                if (data.caption) {
                    $bubble.append($('<div class="media-caption">').text(data.caption));
                }
                $messages.append($msg);
                $messages.scrollTop($messages[0].scrollHeight);
                saveHistory();
            }
        });
        
        eventSource.onerror = function() {
            $status.text('Disconnected').removeClass('bg-success bg-secondary').addClass('bg-danger');
            eventSource.close();
            eventSource = null;
            reconnectTimer = setTimeout(connect, 5000); // Reconnect after 5s
        };
    }
    
    function appendMessage(role, content) {
        renderMessage(role, content, true);
        $messages.scrollTop($messages[0].scrollHeight);
    }
    
    function showTypingIndicator() {
        if ($('#typing-indicator').length === 0) {
            $messages.append('<div id="typing-indicator" class="typing-indicator">' +
                '<i class="bi bi-three-dots"></i> Agent is typing...</div>');
            $messages.scrollTop($messages[0].scrollHeight);
        }
    }
    
    function hideTypingIndicator() {
        $('#typing-indicator').remove();
    }
    
    // Send message
    $('#chat-form').on('submit', function(e) {
        e.preventDefault();
        var message = $input.val().trim();
        if (!message) return;
        
        // Show user message immediately
        appendMessage('user', message);
        $input.val('');
        $sendBtn.prop('disabled', true);
        
        // Send to API
        $.ajax({
            url: '/api/send',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ message: message }),
            success: function(data) {
                console.log('Message sent:', data);
            },
            error: function(xhr) {
                appendMessage('error', 'Failed to send message: ' + xhr.responseText);
            },
            complete: function() {
                $sendBtn.prop('disabled', false);
                $input.focus();
            }
        });
    });
    
    // Clear history button
    $('#clear-history').on('click', function() {
        if (confirm('Clear chat history?')) {
            clearHistory();
        }
    });

    // Load history and start connection
    loadHistory();
    connect();
    $input.focus();
});
</script>

{{template "footer" .}}
